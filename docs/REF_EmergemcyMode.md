EM MODE架構

**進入方式**
進入需要使用ROTARY 三擊，切換後同時發一則SOS訊號出去
亦可監聽是否有@EMERGENCY ACTIVE等文字訊息
倘若有收到則被動轉換成該模式的同時發定位封包出去

**UI介面**
應新增專一的UI模組
該模式下LED應呈現紅色調性並做定期呼吸效果

**關頭訊息**
應切換文字選單，變為
-我受困了

-需要醫療

-需要物資
   
-我在這裡

**EM MODE應符合302.1協議**


EM UI（最小侵入）規格
目的

在 EM 模式 下於畫面上方建立固定面板（overlay 概念），常駐顯示 4 個罐頭選項：


不改既有 Frame/Face/動畫流程；面板只是在最後一層疊上去。

顯示條件

只有 emActive == true 時才顯示 EM 面板；一般模式不顯示、不影響。

版面（建議）

標頭列：上方細長橫條，標示「EMERGENCY」；

彩色屏：紅色底＋白字；單色屏：反白底＋黑字。

清單列：標頭下方垂直 4 列，等高分布；

文字靠左，保留 2–4px 內邊距；

選取列高亮（彩色屏用紅底黑字；單色屏用反白）。

資訊角落（可選）：右上角一行小字顯示座標/電量簡述；若與既有狀態列重疊則關閉。

動畫與互動

常駐：面板在所有 Frame/動畫上方；SEND/RECEIVE/ACK/NACK 動畫播放結束後面板仍在。

Idle 呼吸：

EM 模式 Idle 改為 紅色呼吸（抑制一般橘色）；

動畫期間暫停呼吸；動畫淡出後恢復紅色呼吸。


送出後播放對應 SEND/ACK/NACK 視覺與聲音回饋。

項目對映（完全符合 302.1）

我受困了 → STATUS: TRAPPED（含座標，ACK 必須，有限重試）

需要醫療 → NEED: MEDICAL（含座標，ACK 必須，有限重試）

需要物資 → NEED: SUPPLIES（含座標，ACK 必須，有限重試）

我在這裡 → STATUS: OK（含座標＋電量，ACK 不需要，不重試）

背景策略（不佔面板）：

進入 EM（Rotary 三擊）立刻送 SOS：CRITICAL、ACK 必須、無限重試直到 ACK。

取消 SOS：維持 GPIO5 雙擊 = SAFE（不佔面板）。

被動轉 EM：收到 白名單 的 @EmergencyActive 時切 EM 並送 STATUS:OK。

HEARTBEAT：系統週期送（不顯示）。

可及性與相容性

單色/OLED/E-Ink：高亮用反白，不依賴色彩差；E-Ink 建議降低重繪頻率並使用既有的去殘影策略。

字級：標頭小字、清單中字；行高固定，避免擠壓。

超時策略：長時間無操作仍保持常駐；若你已有全域「資訊彈窗」，其顯示完畢後應自動回到 EM 面板視圖。

效能與更新頻率

面板為 overlay，每幀都會被呼叫；為避免閃爍：

僅在 emActive == true 時繪製；

可加入簡單節流（例如 200–250ms 間隔）或狀態變更才重繪的快取策略。

可靠傳輸與回饋（對齊你現有邏輯）

SOS：無限重試直到 ACK；ACK 綠閃、NACK 紅閃，動畫後回紅色呼吸。

NEED/STATUS：有限重試；超過上限觸發 GiveUp 回調（NACK 視覺），動畫後回紅色呼吸。

進入/退出行為（UI 層）

進入 EM：顯示紅色標頭＋清單；立即播放 SOS 的 SEND/ACK 動畫序列。

退出 EM：回到一般 Idle（橘色呼吸）、隱藏面板；不殘留 EM 調色或標頭。

驗收要點（Screen/UI）

非 EM：面板不出現，現有畫面完全不變。

進入 EM：立即看到紅色標頭＋四列清單；旋鈕可選取，高亮跟隨。

旋鈕按下：對應訊息已送出，並有 SEND→ACK/NACK 動畫；動畫結束面板仍在。

Idle 視覺：EM 下固定紅色呼吸，動畫期間抑制、結束淡出回復。

單色設備：可清晰辨識高亮；無殘影（E-Ink 按你既有策略）。

退出 EM：面板消失、回橘色呼吸、無殘留 UI。



HermesX 302.1 Emergency Mode 清單
UI 顯示 (EM MODE)

LED：紅色呼吸（持續提醒 EM 狀態）

畫面：固定顯示 4 個選項 + 電量狀態

Canned Messages (CAMS)

SOS → 緊急求救（含座標）

302.1 對應：SOS

+ (Medical) → 需要醫療

302.1 對應：NEED

FOOD/WATER → 需要補給

302.1 對應：RESOURCE

SAFE / OK → 我在這裡，但狀況良好（報平安）

302.1 對應：STATUS



附帶行為

若收到 @EmergencyActive，被動切入 EM MODE 並廣播位置